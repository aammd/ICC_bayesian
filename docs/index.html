<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #20794d; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007ba5; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #007ba5; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #007ba5; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #20794d; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>

  <!--radix_placeholder_meta_tags-->
  <title>Bayesian version of the Interclass Correlation Coefficient (ICC)</title>

  <meta property="description" itemprop="description" content="How much do groups contribute to variance in a response? Using posterior simulations to get a simple (?) answer."/>



  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="Bayesian version of the Interclass Correlation Coefficient (ICC)"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="How much do groups contribute to variance in a response? Using posterior simulations to get a simple (?) answer."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:site_name" content="Bayesian version of the Interclass Correlation Coefficient (ICC)"/>

  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="Bayesian version of the Interclass Correlation Coefficient (ICC)"/>
  <meta property="twitter:description" content="How much do groups contribute to variance in a response? Using posterior simulations to get a simple (?) answer."/>

  <!--/radix_placeholder_meta_tags-->
  
  <meta name="citation_reference" content="citation_title=Repeatability for Gaussian and non-Gaussian data: A practical guide for biologists;citation_publication_date=2010;citation_volume=85;citation_doi=10.1111/j.1469-185X.2010.00141.x;citation_issn=1469-185X;citation_author=Shinichi Nakagawa;citation_author=Holger Schielzeth"/>
  <meta name="citation_reference" content="citation_title=R-squared for Bayesian Regression Models;citation_publication_date=2019;citation_volume=73;citation_doi=10.1080/00031305.2018.1549100;citation_issn=0003-1305, 1537-2731;citation_author=Andrew Gelman;citation_author=Ben Goodrich;citation_author=Jonah Gabry;citation_author=Aki Vehtari"/>
  <meta name="citation_reference" content="citation_title=rptR: Repeatability estimation and variance decomposition by generalized linear mixed-effects models;citation_publication_date=2017;citation_volume=8;citation_doi=10.1111/2041-210X.12797;citation_author=Martin A. Stoffel;citation_author=Shinichi Nakagawa;citation_author=Holger Schielzeth"/>
  <!--radix_placeholder_rmarkdown_metadata-->

  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","site","bibliography"]}},"value":[{"type":"character","attributes":{},"value":["Bayesian version of the Interclass Correlation Coefficient (ICC)"]},{"type":"character","attributes":{},"value":["How much do groups contribute to variance in a response? Using posterior simulations to get a simple (?) answer.\n"]},{"type":"character","attributes":{},"value":["distill::distill_website"]},{"type":"character","attributes":{},"value":["refs.bib"]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  <!--radix_placeholder_navigation_in_header-->
  <meta name="distill:offset" content=""/>

  <script type="application/javascript">

    window.headroom_prevent_pin = false;

    window.document.addEventListener("DOMContentLoaded", function (event) {

      // initialize headroom for banner
      var header = $('header').get(0);
      var headerHeight = header.offsetHeight;
      var headroom = new Headroom(header, {
        tolerance: 5,
        onPin : function() {
          if (window.headroom_prevent_pin) {
            window.headroom_prevent_pin = false;
            headroom.unpin();
          }
        }
      });
      headroom.init();
      if(window.location.hash)
        headroom.unpin();
      $(header).addClass('headroom--transition');

      // offset scroll location for banner on hash change
      // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
      window.addEventListener("hashchange", function(event) {
        window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
      });

      // responsive menu
      $('.distill-site-header').each(function(i, val) {
        var topnav = $(this);
        var toggle = topnav.find('.nav-toggle');
        toggle.on('click', function() {
          topnav.toggleClass('responsive');
        });
      });

      // nav dropdowns
      $('.nav-dropbtn').click(function(e) {
        $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
        $(this).parent().siblings('.nav-dropdown')
           .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
      });
      $("body").click(function(e){
        $('.nav-dropdown-content').removeClass('nav-dropdown-active');
      });
      $(".nav-dropdown").click(function(e){
        e.stopPropagation();
      });
    });
  </script>

  <style type="text/css">

  /* Theme (user-documented overrideables for nav appearance) */

  .distill-site-nav {
    color: rgba(255, 255, 255, 0.8);
    background-color: #0F2E3D;
    font-size: 15px;
    font-weight: 300;
  }

  .distill-site-nav a {
    color: inherit;
    text-decoration: none;
  }

  .distill-site-nav a:hover {
    color: white;
  }

  @media print {
    .distill-site-nav {
      display: none;
    }
  }

  .distill-site-header {

  }

  .distill-site-footer {

  }


  /* Site Header */

  .distill-site-header {
    width: 100%;
    box-sizing: border-box;
    z-index: 3;
  }

  .distill-site-header .nav-left {
    display: inline-block;
    margin-left: 8px;
  }

  @media screen and (max-width: 768px) {
    .distill-site-header .nav-left {
      margin-left: 0;
    }
  }


  .distill-site-header .nav-right {
    float: right;
    margin-right: 8px;
  }

  .distill-site-header a,
  .distill-site-header .title {
    display: inline-block;
    text-align: center;
    padding: 14px 10px 14px 10px;
  }

  .distill-site-header .title {
    font-size: 18px;
    min-width: 150px;
  }

  .distill-site-header .logo {
    padding: 0;
  }

  .distill-site-header .logo img {
    display: none;
    max-height: 20px;
    width: auto;
    margin-bottom: -4px;
  }

  .distill-site-header .nav-image img {
    max-height: 18px;
    width: auto;
    display: inline-block;
    margin-bottom: -3px;
  }



  @media screen and (min-width: 1000px) {
    .distill-site-header .logo img {
      display: inline-block;
    }
    .distill-site-header .nav-left {
      margin-left: 20px;
    }
    .distill-site-header .nav-right {
      margin-right: 20px;
    }
    .distill-site-header .title {
      padding-left: 12px;
    }
  }


  .distill-site-header .nav-toggle {
    display: none;
  }

  .nav-dropdown {
    display: inline-block;
    position: relative;
  }

  .nav-dropdown .nav-dropbtn {
    border: none;
    outline: none;
    color: rgba(255, 255, 255, 0.8);
    padding: 16px 10px;
    background-color: transparent;
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    margin: 0;
    margin-top: 1px;
    z-index: 2;
  }

  .nav-dropdown-content {
    display: none;
    position: absolute;
    background-color: white;
    min-width: 200px;
    border: 1px solid rgba(0,0,0,0.15);
    border-radius: 4px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
    z-index: 1;
    margin-top: 2px;
    white-space: nowrap;
    padding-top: 4px;
    padding-bottom: 4px;
  }

  .nav-dropdown-content hr {
    margin-top: 4px;
    margin-bottom: 4px;
    border: none;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .nav-dropdown-active {
    display: block;
  }

  .nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
    color: black;
    padding: 6px 24px;
    text-decoration: none;
    display: block;
    text-align: left;
  }

  .nav-dropdown-content .nav-dropdown-header {
    display: block;
    padding: 5px 24px;
    padding-bottom: 0;
    text-transform: uppercase;
    font-size: 14px;
    color: #999999;
    white-space: nowrap;
  }

  .nav-dropdown:hover .nav-dropbtn {
    color: white;
  }

  .nav-dropdown-content a:hover {
    background-color: #ddd;
    color: black;
  }

  .nav-right .nav-dropdown-content {
    margin-left: -45%;
    right: 0;
  }

  @media screen and (max-width: 768px) {
    .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
    .distill-site-header a.nav-toggle {
      float: right;
      display: block;
    }
    .distill-site-header .title {
      margin-left: 0;
    }
    .distill-site-header .nav-right {
      margin-right: 0;
    }
    .distill-site-header {
      overflow: hidden;
    }
    .nav-right .nav-dropdown-content {
      margin-left: 0;
    }
  }


  @media screen and (max-width: 768px) {
    .distill-site-header.responsive {position: relative; min-height: 500px; }
    .distill-site-header.responsive a.nav-toggle {
      position: absolute;
      right: 0;
      top: 0;
    }
    .distill-site-header.responsive a,
    .distill-site-header.responsive .nav-dropdown {
      display: block;
      text-align: left;
    }
    .distill-site-header.responsive .nav-left,
    .distill-site-header.responsive .nav-right {
      width: 100%;
    }
    .distill-site-header.responsive .nav-dropdown {float: none;}
    .distill-site-header.responsive .nav-dropdown-content {position: relative;}
    .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
      display: block;
      width: 100%;
      text-align: left;
    }
  }

  /* Site Footer */

  .distill-site-footer {
    width: 100%;
    overflow: hidden;
    box-sizing: border-box;
    z-index: 3;
    margin-top: 30px;
    padding-top: 30px;
    padding-bottom: 30px;
    text-align: center;
  }

  /* Headroom */

  d-title {
    padding-top: 6rem;
  }

  @media print {
    d-title {
      padding-top: 4rem;
    }
  }

  .headroom {
    z-index: 1000;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
  }

  .headroom--transition {
    transition: all .4s ease-in-out;
  }

  .headroom--unpinned {
    top: -100px;
  }

  .headroom--pinned {
    top: 0;
  }

  /* adjust viewport for navbar height */
  /* helps vertically center bootstrap (non-distill) content */
  .min-vh-100 {
    min-height: calc(100vh - 100px) !important;
  }

  </style>

  <script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
  <link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet"/>
  <link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet"/>
  <script src="site_libs/headroom-0.9.4/headroom.min.js"></script>
  <script src="site_libs/autocomplete-0.37.1/autocomplete.min.js"></script>
  <script src="site_libs/fuse-6.4.1/fuse.min.js"></script>

  <script type="application/javascript">

  function getMeta(metaName) {
    var metas = document.getElementsByTagName('meta');
    for (let i = 0; i < metas.length; i++) {
      if (metas[i].getAttribute('name') === metaName) {
        return metas[i].getAttribute('content');
      }
    }
    return '';
  }

  function offsetURL(url) {
    var offset = getMeta('distill:offset');
    return offset ? offset + '/' + url : url;
  }

  function createFuseIndex() {

    // create fuse index
    var options = {
      keys: [
        { name: 'title', weight: 20 },
        { name: 'categories', weight: 15 },
        { name: 'description', weight: 10 },
        { name: 'contents', weight: 5 },
      ],
      ignoreLocation: true,
      threshold: 0
    };
    var fuse = new window.Fuse([], options);

    // fetch the main search.json
    return fetch(offsetURL('search.json'))
      .then(function(response) {
        if (response.status == 200) {
          return response.json().then(function(json) {
            // index main articles
            json.articles.forEach(function(article) {
              fuse.add(article);
            });
            // download collections and index their articles
            return Promise.all(json.collections.map(function(collection) {
              return fetch(offsetURL(collection)).then(function(response) {
                if (response.status === 200) {
                  return response.json().then(function(articles) {
                    articles.forEach(function(article) {
                      fuse.add(article);
                    });
                  })
                } else {
                  return Promise.reject(
                    new Error('Unexpected status from search index request: ' +
                              response.status)
                  );
                }
              });
            })).then(function() {
              return fuse;
            });
          });

        } else {
          return Promise.reject(
            new Error('Unexpected status from search index request: ' +
                        response.status)
          );
        }
      });
  }

  window.document.addEventListener("DOMContentLoaded", function (event) {

    // get search element (bail if we don't have one)
    var searchEl = window.document.getElementById('distill-search');
    if (!searchEl)
      return;

    createFuseIndex()
      .then(function(fuse) {

        // make search box visible
        searchEl.classList.remove('hidden');

        // initialize autocomplete
        var options = {
          autoselect: true,
          hint: false,
          minLength: 2,
        };
        window.autocomplete(searchEl, options, [{
          source: function(query, callback) {
            const searchOptions = {
              isCaseSensitive: false,
              shouldSort: true,
              minMatchCharLength: 2,
              limit: 10,
            };
            var results = fuse.search(query, searchOptions);
            callback(results
              .map(function(result) { return result.item; })
            );
          },
          templates: {
            suggestion: function(suggestion) {
              var img = suggestion.preview && Object.keys(suggestion.preview).length > 0
                ? `<img src="${offsetURL(suggestion.preview)}"</img>`
                : '';
              var html = `
                <div class="search-item">
                  <h3>${suggestion.title}</h3>
                  <div class="search-item-description">
                    ${suggestion.description || ''}
                  </div>
                  <div class="search-item-preview">
                    ${img}
                  </div>
                </div>
              `;
              return html;
            }
          }
        }]).on('autocomplete:selected', function(event, suggestion) {
          window.location.href = offsetURL(suggestion.path);
        });
        // remove inline display style on autocompleter (we want to
        // manage responsive display via css)
        $('.algolia-autocomplete').css("display", "");
      })
      .catch(function(error) {
        console.log(error);
      });

  });

  </script>

  <style type="text/css">

  .nav-search {
    font-size: x-small;
  }

  /* Algolioa Autocomplete */

  .algolia-autocomplete {
    display: inline-block;
    margin-left: 10px;
    vertical-align: sub;
    background-color: white;
    color: black;
    padding: 6px;
    padding-top: 8px;
    padding-bottom: 0;
    border-radius: 6px;
    border: 1px #0F2E3D solid;
    width: 180px;
  }


  @media screen and (max-width: 768px) {
    .distill-site-nav .algolia-autocomplete {
      display: none;
      visibility: hidden;
    }
    .distill-site-nav.responsive .algolia-autocomplete {
      display: inline-block;
      visibility: visible;
    }
    .distill-site-nav.responsive .algolia-autocomplete .aa-dropdown-menu {
      margin-left: 0;
      width: 400px;
      max-height: 400px;
    }
  }

  .algolia-autocomplete .aa-input, .algolia-autocomplete .aa-hint {
    width: 90%;
    outline: none;
    border: none;
  }

  .algolia-autocomplete .aa-hint {
    color: #999;
  }
  .algolia-autocomplete .aa-dropdown-menu {
    width: 550px;
    max-height: 70vh;
    overflow-x: visible;
    overflow-y: scroll;
    padding: 5px;
    margin-top: 3px;
    margin-left: -150px;
    background-color: #fff;
    border-radius: 5px;
    border: 1px solid #999;
    border-top: none;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion {
    cursor: pointer;
    padding: 5px 4px;
    border-bottom: 1px solid #eee;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion:last-of-type {
    border-bottom: none;
    margin-bottom: 2px;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item {
    overflow: hidden;
    font-size: 0.8em;
    line-height: 1.4em;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item h3 {
    font-size: 1rem;
    margin-block-start: 0;
    margin-block-end: 5px;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-description {
    display: inline-block;
    overflow: hidden;
    height: 2.8em;
    width: 80%;
    margin-right: 4%;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview {
    display: inline-block;
    width: 15%;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img {
    height: 3em;
    width: auto;
    display: none;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img[src] {
    display: initial;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion.aa-cursor {
    background-color: #eee;
  }
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion em {
    font-weight: bold;
    font-style: normal;
  }

  </style>


  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

  <style type="text/css">

  body {
    background-color: white;
  }

  .pandoc-table {
    width: 100%;
  }

  .pandoc-table>caption {
    margin-bottom: 10px;
  }

  .pandoc-table th:not([align]) {
    text-align: left;
  }

  .pagedtable-footer {
    font-size: 15px;
  }

  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }

  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }

  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }

  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }

  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }

  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
  }

  .html-widget {
    margin-bottom: 2.0em;
  }

  .l-screen-inset {
    padding-right: 16px;
  }

  .l-screen .caption {
    margin-left: 10px;
  }

  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .shaded-content {
    background: white;
  }

  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }

  .hidden {
    display: none !important;
  }

  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
  }

  d-appendix {
    padding-top: 30px;
  }

  d-article>p>img {
    width: 100%;
  }

  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }

  d-article h3 {
    margin-top: 1.5rem;
  }

  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }

  /* Tweak code blocks */

  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }

  d-article div.sourceCode {
    background-color: white;
  }

  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }

  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  d-article pre a {
    border-bottom: none;
  }

  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }

  d-article details {
    grid-column: text;
    margin-bottom: 0.8em;
  }

  @media(min-width: 768px) {

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }

  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }

  d-article pre {
    font-size: 14px;
  }

  }

  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  /* CSS for d-contents */

  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }

  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }

  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }

  .d-contents li {
    list-style-type: none
  }

  .d-contents nav > ul {
    padding-left: 0;
  }

  .d-contents ul {
    padding-left: 1em
  }

  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }

  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }

  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }

  .d-contents nav > ul > li > a {
    font-weight: 600;
  }

  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }

  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }


  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }

  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }


  /* Figure */

  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }

  .figure img {
    width: 100%;
  }

  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }

  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }

  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }

  /* Citations */

  d-article .citation {
    color: inherit;
    cursor: inherit;
  }

  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }

  /* Citation hover box */

  .tippy-box[data-theme~=light-border] {
    background-color: rgba(250, 250, 250, 0.95);
  }

  .tippy-content > p {
    margin-bottom: 0;
    padding: 2px;
  }


  /* Tweak 1000px media break to show more text */

  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }

    .grid {
      grid-column-gap: 16px;
    }

    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }

  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }

    .grid {
      grid-column-gap: 32px;
    }
  }


  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */

  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Include appendix styles here so they can be overridden */

  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }

  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }

  d-appendix h3 + * {
    margin-top: 1em;
  }

  d-appendix ol {
    padding: 0 0 0 15px;
  }

  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }

  d-appendix li {
    margin-bottom: 1em;
  }

  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }

  d-appendix > * {
    grid-column: text;
  }

  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }

  /* Include footnote styles here so they can be overridden */

  d-footnote-list {
    contain: layout style;
  }

  d-footnote-list > * {
    grid-column: text;
  }

  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }



  /* Anchor.js */

  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }

  /* Social footer */

  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }

  .disqus-comments {
    margin-right: 30px;
  }

  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }

  #disqus_thread {
    margin-top: 30px;
  }

  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }

  .article-sharing a:hover {
    border-bottom: none;
  }

  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }

  .subscribe p {
    margin-bottom: 0.5em;
  }


  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }


  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }

  .custom p {
    margin-bottom: 0.5em;
  }

  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }

  /* Styles for posts lists (not auto-injected) */


  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }

  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }

  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }

  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }

  .post-preview-last {
    border-bottom: none !important;
  }

  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }

  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }

  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }

  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }

  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }

  .posts-list .metadata > * {
    display: inline-block;
  }

  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }

  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }

  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }

  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  .posts-list img {
    opacity: 1;
  }

  .posts-list img[data-src] {
    opacity: 0;
  }

  .posts-more {
    clear: both;
  }


  .posts-sidebar {
    font-size: 16px;
  }

  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }

  .sidebar-section {
    margin-bottom: 30px;
  }

  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }

  .categories li>a {
    border-bottom: none;
  }

  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }

  .categories .active {
    font-weight: 600;
  }

  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }


  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }


  /* Improve display for browsers without grid (IE/Edge <= 15) */

  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }

  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }

  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }

  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }

  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }

  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }


  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }

  .downlevel .footnotes ol {
    padding-left: 13px;
  }

  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }

  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }

  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }

  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  .downlevel .posts-list .post-preview {
    color: inherit;
  }



  </style>

  <script type="application/javascript">

  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }

  // show body when load is complete
  function on_load_complete() {

    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }


    // set body to visible
    document.body.style.visibility = 'visible';

    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }

    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }

  function init_distill() {

    init_common();

    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);

    // create d-title
    $('.d-title').changeElementType('d-title');

    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);

    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();

    // move posts container into article
    $('.posts-container').appendTo($('d-article'));

    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');

    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;

    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();

    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));

    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });

    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');

    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {

      // capture layout
      var layout = $(this).attr('data-layout');

      // apply layout to markdown level block elements
      var elements = $(this).children().not('details, div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });


      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });

    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();

    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme
    $('code.sourceCode a:empty').remove();

    // load distill framework
    load_distill_framework();

    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {

      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;

      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');

      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');

      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });

      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }

      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");

      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }

       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }

      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();

      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();

      // hoverable references
      $('span.citation[data-cites]').each(function() {
        var refHtml = $('#ref-' + $(this).attr('data-cites')).html();
        window.tippy(this, {
          allowHTML: true,
          content: refHtml,
          maxWidth: 500,
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        });
      });

      // clear polling timer
      clearInterval(tid);

      // show body now that everything is ready
      on_load_complete();
    }

    var tid = setInterval(distill_post_process, 50);
    distill_post_process();

  }

  function init_downlevel() {

    init_common();

     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));

    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;

    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();

    // remove toc
    $('.d-contents').remove();

    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });


    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);

    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();

    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });

    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));

    $('body').addClass('downlevel');

    on_load_complete();
  }


  function init_common() {

    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};

        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });

        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);

    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});

    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });

      }
    });

    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });

    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
      });
    }

    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');

    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");

    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();

    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });

  </script>

  <!--/radix_placeholder_distill-->
  <script src="site_libs/header-attrs-2.11.3/header-attrs.js"></script>
  <script src="site_libs/popper-2.6.0/popper.min.js"></script>
  <link href="site_libs/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="site_libs/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="site_libs/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="site_libs/anchor-4.2.2/anchor.min.js"></script>
  <script src="site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Bayesian version of the Interclass Correlation Coefficient (ICC)","description":"How much do groups contribute to variance in a response? Using posterior simulations to get a simple (?) answer.","authors":[]}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<a href="index.html" class="title">Bayesian version of the Interclass Correlation Coefficient (ICC)</a>
</div>
<div class="nav-right">
<a href="index.html">Home</a>
<a href="about.html">About</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Bayesian version of the Interclass Correlation Coefficient (ICC)</h1>
<!--radix_placeholder_categories-->
<!--/radix_placeholder_categories-->
<p><p>How much do groups contribute to variance in a response? Using posterior simulations to get a simple (?) answer.</p></p>
</div>


<div class="d-article">
<p>How much variation is contributed by group differences? This is a useful question in several contexts. Sometimes it is simply a guide to model building  is it worth it to include group effects in my model? In other projects we might care about measuring variation explicitly. For example, we might want to measure what proportion of phenotypic variation can be ascribed to different genotypes. Or we might have different experimental subjects, and we want to know if the same subject responds in the same way across trials.</p>
<p>Clearly, observations from the same subject will be correlated to each other, since all those observations come from the same person/animal/thing, which differs in all kinds of unmeasured ways from the other people/animal/things we are studying. This correlation is measured, for some models, using the interclass correlation coefficient (ICC). The trouble is that the ICC:</p>
<ul>
<li>Doesnt have any uncertainty estimates  since it comes from a model, we have to represent a distribution of possible correlations consistent with the data</li>
<li>Only works sometimes. There are only a few models for which there are formulae to calculate ICC, and a wide class of flexible models are left out with no clear way to proceed.</li>
</ul>
<p>Here Im suggesting an approach to calculate the ICC based on a Bayesian posterior distribution for the model coefficients. The approach is heavily based on the Bayesian R2 <span class="citation" data-cites="GelmGood19a">(<a href="#ref-GelmGood19a" role="doc-biblioref">Gelman et al. 2019</a>)</span>. The approach Im suggesting replaces a single value of ICC with a distribution. However, for models beyond simple intercept-only models, this ICC calculation produces a curve, <span class="math inline">\(\text{ICC}(x)\)</span>, because in these cases the contribution of group effects depends on the rest of the model.</p>
<p>Below is a quick description of what Im suggesting followed by some simulations testing it in a few interesting cases.</p>
<h2 id="what-is-the-icc">What is the ICC</h2>
<p>The ICC is the proportion of total variation that comes from group differences. The simplest and most intuitive formula comes from a gaussian model with random intercepts, like this one:</p>
<p><span class="math display">\[
\begin{align}
y_i &amp;\sim \text{Normal}(\mu_i, \sigma_{obs}^2) \\
\mu_i &amp;= \alpha_0 + X_i\beta+ \alpha_{\text{group}[i]} \\
\alpha_{\text{group}} &amp;\sim \text{Normal}(0, \sigma_{\text{group}}^2)
\end{align}
\]</span></p>
<p>That is, a gaussian response with random intercepts for groups. In this case, <span class="math inline">\(X_i\beta\)</span> could be any vector of predictors, multiplied by their coefficients.</p>
<p>Here, the ICC is a ratio of the hyperparameter <span class="math inline">\(\sigma_{\text{group}}^2\)</span> to sum of that hyperparameter and the residual variance, <span class="math inline">\(\sigma_{\text{obs}}^2\)</span>.</p>
<p><span class="math display">\[
\frac{\sigma_{group}^2}{\sigma_{group}^2 + \sigma_{obs}^2}
\]</span></p>
<p>Since all variation in the above model comes from one of these two places, the result is the proportion of variation which comes from group differences.</p>
<h2 id="proposed-simulation-based-version">Proposed simulation based version</h2>
<p>The idea for an ICC based on simulations is inspired by the Bayesian R^2 equation of <span class="citation" data-cites="GelmGood19a">(<a href="#ref-GelmGood19a" role="doc-biblioref">Gelman et al. 2019</a>)</span>, which is also explained in <a href="https://avehtari.github.io/ROS-Examples/Rsquared/rsquared.html">this excellent workbook</a> by Gelman, Hill and Vehtari:</p>
<p><span class="math display">\[
R^2 = \frac{\text{Var}_\mu}{\text{Var}_\mu + \text{Var}_{\text{res}}}
\]</span></p>
<p>Here <span class="math inline">\(\mu\)</span> is the model fitted values:</p>
<p><span class="math display">\[
\text{Var}_\mu^s = V_{n=1}^N\mu_n^s
\]</span></p>
<p>We also need the residual variance. To make it general, we use the expected residual variance like this:</p>
<p><span class="math display">\[
\text{Var}_{\text{res}}^s = \frac{1}{N}\sum_{n=1}^N (\text{Var}_{\text{res}})_n^s
\]</span></p>
<p>In words: for every posterior draw <span class="math inline">\(s\)</span>, get the variance for each observation <span class="math inline">\(n\)</span> and average them. In a gaussian regression with a constant variance you would of course get a constant:</p>
<p><span class="math display">\[
\frac{1}{N}\sum_{n=1}^N (\text{Var}_{\text{res}})_n^s = \frac{1}{N}\sum_{n=1}^N (\sigma^2)^s = (\sigma^2)^s
\]</span></p>
<p>But thats not true for example in a logistic regression (this is the example given in the workbook linked above), where the mean and the variance have a close relationship. If the mean for observation number <span class="math inline">\(n\)</span> in draw <span class="math inline">\(s\)</span> is <span class="math inline">\(\pi_n^s\)</span>, then:</p>
<p><span class="math display">\[
\frac{1}{N}\sum_{n=1}^N (\text{Var}_{\text{res}})_n^s = \frac{1}{N}\sum_{n=1}^N \pi_n^s(1-\pi_n^s)
\]</span></p>
<p>In this calculation, we look at the variance <em>across the models fitted values</em> and combine it with the <em>expected variance for each fitted value</em>.</p>
<p>The approach Im suggesting is basically the same equation in two dimensions. The recipie goes like this:</p>
<ul>
<li>For each posterior sample <span class="math inline">\(\theta^s\)</span>, draw <span class="math inline">\(K\)</span> groups from the hyperpriors that define the groups. Typically this will be a univariate or multivariate gaussian distribution. Each group has its id number: <span class="math inline">\(1 ... k ... K\)</span>. You end up with a matrix of group-level parameters, with dimensions <span class="math inline">\(S\)</span> and <span class="math inline">\(K\)</span>.</li>
<li>Create a smooth vector of <span class="math inline">\(x\)</span> values to predict across, within the range of your original <span class="math inline">\(x\)</span> values. Make <span class="math inline">\(M\)</span> of these values, <span class="math inline">\(x_{\text{min}} ... m ... x_{\text{max}}\)</span>.</li>
<li>For each value <span class="math inline">\(m\)</span>, AND for each posterior sample <span class="math inline">\(s\)</span> calculate the variance across all the <span class="math inline">\(K\)</span> groups when $ x = m $:</li>
</ul>
<p><span class="math display">\[
\text{ICC}(x = m) = \frac{
V_{k=1}^K(\mu_m)_k^s
}{
V_{k=1}^K(\mu_m)_k^s + \frac{1}{K}\sum_{k=1}^K (\text{Var}_m^{\text{res}})_k^s
}
\]</span></p>
<p>What this snarled notation is meant to convey is: We can calculate the ICC in a very similar way to the bayes <span class="math inline">\(R^2\)</span> value. In this case, instead of calculating the variance across the <span class="math inline">\(X_n\)</span> observations, we calculate the variance across the <span class="math inline">\(k\)</span> groups for some particular value of <span class="math inline">\(x\)</span>, say when <span class="math inline">\(x = m\)</span>.</p>
<p><span class="math inline">\((\mu_m)_k^s\)</span> is the expected value of the model when <span class="math inline">\(x=m\)</span>, for group <span class="math inline">\(k\)</span> and posterior draw <span class="math inline">\(s\)</span>. For the model above this would be:</p>
<p><span class="math display">\[
(\mu_m)_k^s = \alpha_0^s + m\times\beta^s+ \alpha_{\text{group }k}^s
\]</span></p>
<p>Where <span class="math inline">\(m\)</span> is one particular value for <span class="math inline">\(x\)</span>. In all the models Ive tried this on so far, theres been a single univariate <span class="math inline">\(x\)</span> value<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. By calculating the variance across <span class="math inline">\(k\)</span> values of <span class="math inline">\((\mu_m)_k^s\)</span>, we get an estimate of how much groups contribute to overall variation at <span class="math inline">\(x = m\)</span>, according to posterior draw <span class="math inline">\(s\)</span>.</p>
<p>Residual variance, <span class="math inline">\(\text{Var}_m^{\text{res}}\)</span>, is one constant number for any gaussian regression in a particular posterior draw <span class="math inline">\(s\)</span>. For most (all?) other regressions, it will typically be some function of <span class="math inline">\(m\)</span>. For example, in a logistic regression it would be <span class="math inline">\(\mu_m(1-\mu_m)\)</span>.</p>
<aside>
<span class="math inline">\(\mu_m\)</span> is of course a function of <span class="math inline">\(m\)</span>, since <span class="math display">\[
\text{logit}(\mu_m) = \alpha_0 + m*\beta + \alpha_{\text{group }k}
\]</span>
</aside>
<p>In these cases it will also be a function of the group offsets, and so each group <span class="math inline">\(k\)</span> will have its own residual variance. There might even be a model where residuals differ among groups (i.e.groups which are more or less predictable, with a greater or smaller variance). Because each of the <span class="math inline">\(K\)</span> groups will have its own variance in these cases, we take the average.</p>
<aside>
Is the mean a good way to summarize the expected value of residual variance for models where the different groups have very different variances?? Maybe the median would be a more sensible choice!
</aside>
<p>The goal of the rest of this document is to experiment with this calculation of <span class="math inline">\(\text{ICC}(x)\)</span>. First Ill compare it to previous means of calculating ICC, then extend it to cases where that calculation isnt possible.<br />
Everything is based on simulated data.</p>
<p>In the notes below Ill refer to three kinds of ICC calculation:</p>
<ul>
<li><em>Frequentist</em>, AKA <span class="math inline">\(ICC_F\)</span> using the point estimates from a ML model for the parameters and hyperparameters involved. This is the value produced by the <code>rptR</code> package.</li>
<li><em>Bayesian (analytic)</em> AKA <span class="math inline">\(\text{ICC}_B\)</span> applying the same formula as the frequentist approach, but using posterior draws for the (hyper)parameters. This produces a posterior distribution of ICC values.</li>
<li><em>Bayesian (simulation)</em> AKA <span class="math inline">\(\text{ICC}(x)\)</span>, which is the approach Im exploring here. This produces a value of the ICC for possible values of <span class="math inline">\(x\)</span>. The result can be visualized as a function of <span class="math inline">\(x\)</span>. For simple models this will be a flat line, with a marginal distribution that resembles that of <span class="math inline">\(ICC_B\)</span>. For all other models it will be a function with different values depending on <span class="math inline">\(x\)</span></li>
</ul>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>knitr</span><span class='fu'>::</span><span class='va'><a href='https://rdrr.io/pkg/knitr/man/opts_chunk.html'>opts_chunk</a></span><span class='op'>$</span><span class='fu'>set</span><span class='op'>(</span>echo <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/lme4/lme4/'>lme4</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>rptR</span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/paul-buerkner/brms'>brms</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tidyverse.tidyverse.org'>tidyverse</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://mjskay.github.io/tidybayes/'>tidybayes</a></span><span class='op'>)</span>
</code></pre>
</div>
</div>
<h2 id="gaussian-random-intercepts-model">Gaussian random intercepts model</h2>
<p>Imagine a simple experiment: different genetic lines of the same plant are each exposed to different amounts of water. Their growth is normally distributed around an average determined by how much water they get. The different genetic lines are different in their growth but all respond precisely the same way to the addition of water:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>water</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fl'>50</span><span class='op'>)</span>

<span class='va'>avg_size</span> <span class='op'>&lt;-</span> <span class='fl'>23</span>

<span class='va'>ecart_size</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='fl'>20</span>, mean <span class='op'>=</span> <span class='fl'>0</span>, sd <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span>

<span class='va'>slope_water</span> <span class='op'>&lt;-</span> <span class='fl'>4.2</span>
<span class='va'>obs_sd</span> <span class='op'>&lt;-</span> <span class='fl'>2</span>

<span class='va'>obs_data</span> <span class='op'>&lt;-</span> <span class='fu'>expand_grid</span><span class='op'>(</span>sp_id <span class='op'>=</span> <span class='fl'>1</span><span class='op'>:</span><span class='fl'>20</span>,
            <span class='va'>water</span><span class='op'>)</span> |&gt;
  <span class='fu'>mutate</span><span class='op'>(</span>avg <span class='op'>=</span> <span class='va'>avg_size</span> <span class='op'>+</span> <span class='va'>ecart_size</span><span class='op'>[</span><span class='va'>sp_id</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>slope_water</span><span class='op'>*</span><span class='va'>water</span>, 
         obs <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>avg</span><span class='op'>)</span>, mean <span class='op'>=</span> <span class='va'>avg</span>, sd <span class='op'>=</span> <span class='va'>obs_sd</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>obs_data</span> |&gt;
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>water</span>, y <span class='op'>=</span> <span class='va'>obs</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>geom_point</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>avg</span>, group <span class='op'>=</span> <span class='va'>sp_id</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>labs</span><span class='op'>(</span>x <span class='op'>=</span> <span class='st'>"Water"</span>, y <span class='op'>=</span> <span class='st'>"Mass"</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="index_files/figure-html5/unnamed-chunk-1-1.png" width="624" /></p>
</div>
<h3 id="frequentist-calculation">Frequentist calculation</h3>
<p>How much of the variation in growth is contributed by plant lines? In other words, what proportion of total variance comes from genetic differences? We can apply the formula above by manually extracting the variance components from the model:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>lmer_mod</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/lme4/man/lmer.html'>lmer</a></span><span class='op'>(</span><span class='va'>obs</span><span class='op'>~</span><span class='va'>water</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>|</span> <span class='va'>sp_id</span><span class='op'>)</span>, data <span class='op'>=</span> <span class='va'>obs_data</span><span class='op'>)</span>

<span class='va'>gauss_vc</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/lme4/man/VarCorr.html'>VarCorr</a></span><span class='op'>(</span><span class='va'>lmer_mod</span><span class='op'>)</span> |&gt; <span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>freq_line</span> <span class='op'>&lt;-</span> <span class='va'>gauss_vc</span><span class='op'>$</span><span class='va'>vcov</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span><span class='op'>/</span><span class='op'>(</span><span class='va'>gauss_vc</span><span class='op'>$</span><span class='va'>vcov</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>gauss_vc</span><span class='op'>$</span><span class='va'>vcov</span><span class='op'>[[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span>
<span class='va'>freq_line</span>
</code></pre>
</div>
<pre><code>[1] 0.6057147</code></pre>
</div>
<p>We can do the same with the <code>rptR</code> package <span class="citation" data-cites="stoffel2017">(<a href="#ref-stoffel2017" role="doc-biblioref">Stoffel, Nakagawa, and Schielzeth 2017</a>)</span></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>rpt_obs</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/rptR/man/rpt.html'>rpt</a></span><span class='op'>(</span><span class='va'>obs</span> <span class='op'>~</span> <span class='va'>water</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>|</span> <span class='va'>sp_id</span><span class='op'>)</span>,
                     data <span class='op'>=</span> <span class='fu'>mutate</span><span class='op'>(</span><span class='va'>obs_data</span>, sp_id <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>sp_id</span><span class='op'>)</span><span class='op'>)</span>,
          grname <span class='op'>=</span> <span class='st'>"sp_id"</span>, datatype <span class='op'>=</span> <span class='st'>"Gaussian"</span>, nboot <span class='op'>=</span> <span class='fl'>0</span>, npermut <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span>

<span class='va'>rpt_obs</span>
</code></pre>
</div>
<pre><code>

Repeatability estimation using the lmm method 

Repeatability for sp_id
R  = 0.606
SE =  NA 
CI = [NA, NA]
P  = 2.37e-179 [LRT]
     NA [Permutation]</code></pre>
</div>
<h3 id="bayesian-calculation-parametric">Bayesian calculation (parametric)</h3>
<p>As noted by <span class="citation" data-cites="NakaSchi10">(<a href="#ref-NakaSchi10" role="doc-biblioref">Nakagawa and Schielzeth 2010</a>)</span>:</p>
<blockquote>
<p>The advantage of using a Bayesian implementation such as MCMCglmm for estimating precisions, is that MCMC samples from the posterior distribution of the parameters (e.g. 2  and  2 e ) can be combined (e.g.according to Eq. 22) to provide a valid posterior distribution for repeatability itself []</p>
</blockquote>
<p>So we can repeat the procedure above, but this time using posterior samples from the parameters. This gives us a distribution which we could use to obtain HPDI intervals or summarize in some other way.</p>
<p>The first step is to fit a bayesian model:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>gaussian_intercept_bf</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsformula.html'>bf</a></span><span class='op'>(</span><span class='va'>obs</span><span class='op'>~</span> <span class='va'>water</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>|</span> <span class='va'>sp_id</span><span class='op'>)</span>,
                            family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/family.html'>gaussian</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># get_prior(gaussian_intercept_bf,</span>
<span class='co'>#          data = obs_data)</span>

<span class='va'>gaussian_intercept_priors</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>
  <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>prior</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsfamily.html'>exponential</a></span><span class='op'>(</span><span class='fl'>.3</span><span class='op'>)</span>, class <span class='op'>=</span> <span class='va'>sigma</span><span class='op'>)</span>,
  <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>prior</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsfamily.html'>exponential</a></span><span class='op'>(</span><span class='fl'>.2</span><span class='op'>)</span>, class <span class='op'>=</span> <span class='st'>"sd"</span><span class='op'>)</span>,
  <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>prior</a></span><span class='op'>(</span><span class='fu'>normal</span><span class='op'>(</span><span class='fl'>5</span>, <span class='fl'>6</span><span class='op'>)</span>, class <span class='op'>=</span> <span class='st'>"b"</span><span class='op'>)</span>,
  <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>prior</a></span><span class='op'>(</span><span class='fu'>normal</span><span class='op'>(</span><span class='fl'>50</span>, <span class='fl'>10</span><span class='op'>)</span>, class <span class='op'>=</span> <span class='st'>"Intercept"</span><span class='op'>)</span>
<span class='op'>)</span>


<span class='va'>gaussian_brm</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brm.html'>brm</a></span><span class='op'>(</span><span class='va'>gaussian_intercept_bf</span>,
                 prior <span class='op'>=</span> <span class='va'>gaussian_intercept_priors</span>,
                 data <span class='op'>=</span> <span class='va'>obs_data</span>, file <span class='op'>=</span> <span class='st'>"gaussian_brm"</span>,
                 backend <span class='op'>=</span> <span class='st'>"cmdstanr"</span>, cores <span class='op'>=</span> <span class='fl'>4</span><span class='op'>)</span>

<span class='va'>gaussian_brm</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/update.html'>update</a></span><span class='op'>(</span><span class='va'>gaussian_brm</span>, newdata <span class='op'>=</span> <span class='va'>obs_data</span>, cores <span class='op'>=</span> <span class='fl'>4</span>, refresh <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Running MCMC with 4 parallel chains...

Chain 4 finished in 7.0 seconds.
Chain 1 finished in 7.5 seconds.
Chain 2 finished in 8.1 seconds.
Chain 3 finished in 8.2 seconds.

All 4 chains finished successfully.
Mean chain execution time: 7.7 seconds.
Total execution time: 8.5 seconds.</code></pre>
</div>
<p>The following creates the <span class="math inline">\(K\)</span> groups for each posterior sample. I visualize one sample just to show that (1) they look just like the original groups (2) theres a lot of them. At this stage it is <em>absolutely critical</em> if you are using <code>brms</code> that you set the option <code>sample_new_levels = "gaussian"</code>. All this and more is described in Andrew Heisss <a href="https://www.andrewheiss.com/blog/2021/11/10/ame-bayes-re-guide/">fabulous blog on the topic</a></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>sample_draws</span> <span class='op'>&lt;-</span> <span class='fu'>expand_grid</span><span class='op'>(</span>sp_id <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span><span class='st'>"newsp"</span>, <span class='fl'>1</span><span class='op'>:</span><span class='fl'>100</span><span class='op'>)</span>,
                            water <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>obs_data</span><span class='op'>$</span><span class='va'>water</span><span class='op'>)</span><span class='op'>)</span> |&gt;
  <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html'>add_epred_draws</a></span><span class='op'>(</span><span class='va'>gaussian_brm</span>,
                  allow_new_levels <span class='op'>=</span> <span class='cn'>TRUE</span>,
                  sample_new_levels<span class='op'>=</span> <span class='st'>"gaussian"</span><span class='op'>)</span>

<span class='va'>sample_draws</span> |&gt; 
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>.draw</span> <span class='op'>==</span> <span class='fl'>121</span><span class='op'>)</span> |&gt; 
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>water</span>, y <span class='op'>=</span> <span class='va'>.epred</span>, group <span class='op'>=</span> <span class='va'>sp_id</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>geom_line</span><span class='op'>(</span>alpha <span class='op'>=</span> <span class='fl'>.3</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>theme_bw</span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<div class="figure">
<img src="index_files/figure-html5/posterior_k_gauss-1.png" alt="100 simulated groups from a single posterior sample of the hyperparameter $\sigma_{\text{group}}^2$" width="624" />
<p class="caption">
(#fig:posterior_k_gauss)100 simulated groups from a single posterior sample of the hyperparameter <span class="math inline">\(\sigma_{\text{group}}^2\)</span>
</p>
</div>
</div>
<p><em>IMPORTANT</em> The next step is one that I tested a few times and I hope is valid. We need to match the average predictions from <code>add_epred_draws</code> to the <span class="math inline">\(\sigma_{\text{res}}\)</span> values <em>from those exact same draws</em>. I <em>think</em> that this works  ie that if you take ALL the posterior draws (not using the <code>ndraws</code> argument) then the numbers of the draws match. If so, then the data frames can be merged together.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>sample_variance</span> <span class='op'>&lt;-</span> <span class='va'>sample_draws</span> |&gt;
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> |&gt;
  <span class='fu'>nest_by</span><span class='op'>(</span><span class='va'>.draw</span>, <span class='va'>water</span><span class='op'>)</span> |&gt;
  <span class='fu'>mutate</span><span class='op'>(</span>Vpred <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/cor.html'>var</a></span><span class='op'>(</span><span class='va'>data</span><span class='op'>$</span><span class='va'>.epred</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>sigma_draws</span> <span class='op'>&lt;-</span> <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>spread_draws</a></span><span class='op'>(</span><span class='va'>gaussian_brm</span>, <span class='va'>sigma</span><span class='op'>)</span>

<span class='va'>icc_of_x</span> <span class='op'>&lt;-</span> <span class='va'>sample_variance</span> |&gt;
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> |&gt;
  <span class='fu'>left_join</span><span class='op'>(</span><span class='va'>sigma_draws</span>, by <span class='op'>=</span> <span class='st'>".draw"</span><span class='op'>)</span> |&gt;
  <span class='fu'>mutate</span><span class='op'>(</span>icc_x <span class='op'>=</span> <span class='va'>Vpred</span><span class='op'>/</span><span class='op'>(</span><span class='va'>Vpred</span> <span class='op'>+</span> <span class='va'>sigma</span><span class='op'>^</span><span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Finally, with this merged dataframe, we can calculate the Bayesian simulation approach (<span class="math inline">\(\text{ICC}(x)\)</span>) and compare it to the Bayesian analytic option (<span class="math inline">\(\text{ICC}_B\)</span>) and the frequentist point estimate (<span class="math inline">\(\text{ICC}_F\)</span>)</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># get_variables(gaussian_brm)</span>

<span class='va'>gaussian_varcomp</span> <span class='op'>&lt;-</span> <span class='va'>gaussian_brm</span> |&gt; 
  <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>spread_draws</a></span><span class='op'>(</span><span class='va'>sd_sp_id__Intercept</span>, <span class='va'>sigma</span><span class='op'>)</span>

<span class='va'>gaussian_varcomp</span> |&gt; 
  <span class='fu'>mutate</span><span class='op'>(</span>icc_analytic <span class='op'>=</span> <span class='va'>sd_sp_id__Intercept</span><span class='op'>^</span><span class='fl'>2</span><span class='op'>/</span><span class='op'>(</span><span class='va'>sd_sp_id__Intercept</span><span class='op'>^</span><span class='fl'>2</span> <span class='op'>+</span> <span class='va'>sigma</span><span class='op'>^</span><span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span> |&gt; 
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>icc_analytic</span><span class='op'>)</span><span class='op'>)</span>  <span class='op'>+</span>
  <span class='fu'>geom_density</span><span class='op'>(</span>lwd <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>geom_density</span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>icc_of_x</span>, <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>icc_x</span><span class='op'>)</span>, col <span class='op'>=</span> <span class='st'>"orange"</span>, lwd<span class='op'>=</span><span class='fl'>2</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>geom_vline</span><span class='op'>(</span>xintercept <span class='op'>=</span> <span class='va'>freq_line</span>, col <span class='op'>=</span> <span class='st'>"darkgreen"</span>, lwd<span class='op'>=</span><span class='fl'>2</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>theme_bw</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>labs</span><span class='op'>(</span>x <span class='op'>=</span> <span class='st'>"ICC"</span><span class='op'>)</span>
</code></pre>
</div>
<div class="figure"><span id="fig:ICC-three-ways-gauss"></span>
<img src="index_files/figure-html5/ICC-three-ways-gauss-1.png" alt="Comparison of three ways of calculating the ICC. The vertical green line is the frequentist point estimate. The black curve is the posterior distribution obtained by applying the formula to posterior samples of the hyperparameter and parameter. The orange curve is the simulation based approach for 100 simulated groups." width="624" />
<p class="caption">
Figure 1: Comparison of three ways of calculating the ICC. The vertical green line is the frequentist point estimate. The black curve is the posterior distribution obtained by applying the formula to posterior samples of the hyperparameter and parameter. The orange curve is the simulation based approach for 100 simulated groups.
</p>
</div>
</div>
<p>The pattern is quite similar, which is encouraging! If <span class="math inline">\(\text{ICC}(x)\)</span> gives the same answer as the other two, then it might be a useful tool. It is FAR more computationally demanding, but it is also much more flexible.</p>
<h1 id="off-script">Off script</h1>
<p>In the following sections there are no more comparisons to <span class="math inline">\(\text{ICC}_B\)</span> or <span class="math inline">\(\text{ICC}_F\)</span>, because (as far as I know) its not possible to calculate them for any of these models.</p>
<h2 id="gaussian-random-slopes">Gaussian random slopes</h2>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>water</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fl'>50</span>, min <span class='op'>=</span> <span class='op'>-</span><span class='fl'>1</span>, max <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span>

<span class='va'>avg_size</span> <span class='op'>&lt;-</span> <span class='fl'>23</span>
<span class='va'>avg_eff_water</span> <span class='op'>&lt;-</span> <span class='fl'>7</span>
<span class='va'>corrmat</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span>
  <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='op'>-</span><span class='fl'>.8</span>,
    <span class='op'>-</span><span class='fl'>.8</span>, <span class='fl'>1</span><span class='op'>)</span>, nrow <span class='op'>=</span> <span class='fl'>2</span>, byrow <span class='op'>=</span> <span class='cn'>TRUE</span>
<span class='op'>)</span>

<span class='va'>sds</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>4</span><span class='op'>)</span>
<span class='va'>vcov</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/diag.html'>diag</a></span><span class='op'>(</span><span class='va'>sds</span><span class='op'>)</span> <span class='op'>%*%</span> <span class='va'>corrmat</span> <span class='op'>%*%</span> <span class='fu'><a href='https://rdrr.io/r/base/diag.html'>diag</a></span><span class='op'>(</span><span class='va'>sds</span><span class='op'>)</span>

<span class='va'>b</span> <span class='op'>&lt;-</span> <span class='fu'>MASS</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/MASS/man/mvrnorm.html'>mvrnorm</a></span><span class='op'>(</span><span class='fl'>20</span>, mu <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>0</span><span class='op'>)</span>, Sigma <span class='op'>=</span> <span class='va'>vcov</span><span class='op'>)</span>

<span class='va'>obs_sd</span> <span class='op'>&lt;-</span> <span class='fl'>1</span>

<span class='va'>obs_data</span> <span class='op'>&lt;-</span> <span class='fu'>expand_grid</span><span class='op'>(</span>sp_id <span class='op'>=</span> <span class='fl'>1</span><span class='op'>:</span><span class='fl'>20</span>,
            <span class='va'>water</span><span class='op'>)</span> |&gt;
  <span class='fu'>mutate</span><span class='op'>(</span>avg <span class='op'>=</span> <span class='va'>avg_size</span> <span class='op'>+</span> <span class='va'>avg_eff_water</span><span class='op'>*</span><span class='va'>water</span> <span class='op'>+</span>  <span class='va'>b</span><span class='op'>[</span><span class='va'>sp_id</span>,<span class='fl'>1</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>b</span><span class='op'>[</span><span class='va'>sp_id</span>,<span class='fl'>2</span><span class='op'>]</span><span class='op'>*</span><span class='va'>water</span>, 
         obs <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>avg</span><span class='op'>)</span>, mean <span class='op'>=</span> <span class='va'>avg</span>, sd <span class='op'>=</span> <span class='va'>obs_sd</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>obs_data</span> |&gt;
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>water</span>, y <span class='op'>=</span> <span class='va'>obs</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>geom_point</span><span class='op'>(</span>alpha <span class='op'>=</span> <span class='fl'>.6</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>avg</span>, group <span class='op'>=</span> <span class='va'>sp_id</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>labs</span><span class='op'>(</span>x <span class='op'>=</span> <span class='st'>"Water"</span>, y <span class='op'>=</span> <span class='st'>"Mass"</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="index_files/figure-html5/gaussian_random_slopes-1.png" width="624" /></p>
</div>
<p>Fit a bayesian model and plot the ICC(x)</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>gaussian_slope_bf</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsformula.html'>bf</a></span><span class='op'>(</span><span class='va'>obs</span><span class='op'>~</span> <span class='fl'>1</span><span class='op'>+</span> <span class='va'>water</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>+</span> <span class='va'>water</span> <span class='op'>|</span> <span class='va'>sp_id</span><span class='op'>)</span>,
                            family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/family.html'>gaussian</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>

<span class='fu'><a href='https://rdrr.io/pkg/brms/man/get_prior.html'>get_prior</a></span><span class='op'>(</span><span class='va'>gaussian_slope_bf</span>,
         data <span class='op'>=</span> <span class='va'>obs_data</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>                   prior     class      coef group resp dpar nlpar
                  (flat)         b                                
                  (flat)         b     water                      
                  lkj(1)       cor                                
                  lkj(1)       cor           sp_id                
 student_t(3, 23.3, 4.9) Intercept                                
    student_t(3, 0, 4.9)        sd                                
    student_t(3, 0, 4.9)        sd           sp_id                
    student_t(3, 0, 4.9)        sd Intercept sp_id                
    student_t(3, 0, 4.9)        sd     water sp_id                
    student_t(3, 0, 4.9)     sigma                                
 bound       source
            default
       (vectorized)
            default
       (vectorized)
            default
            default
       (vectorized)
       (vectorized)
       (vectorized)
            default</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>gaussian_slope_priors</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>
  <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>prior</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsfamily.html'>exponential</a></span><span class='op'>(</span><span class='fl'>.3</span><span class='op'>)</span>, class <span class='op'>=</span> <span class='va'>sigma</span><span class='op'>)</span>,
  <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>prior</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsfamily.html'>exponential</a></span><span class='op'>(</span><span class='fl'>.5</span><span class='op'>)</span>, class <span class='op'>=</span> <span class='st'>"sd"</span><span class='op'>)</span>,
  <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>prior</a></span><span class='op'>(</span><span class='fu'>lkj</span><span class='op'>(</span><span class='fl'>2</span><span class='op'>)</span>, class <span class='op'>=</span> <span class='st'>"cor"</span><span class='op'>)</span>,
  <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>prior</a></span><span class='op'>(</span><span class='fu'>normal</span><span class='op'>(</span><span class='fl'>5</span>, <span class='fl'>6</span><span class='op'>)</span>, class <span class='op'>=</span> <span class='st'>"b"</span><span class='op'>)</span>,
  <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>prior</a></span><span class='op'>(</span><span class='fu'>normal</span><span class='op'>(</span><span class='fl'>20</span>, <span class='fl'>10</span><span class='op'>)</span>, class <span class='op'>=</span> <span class='st'>"Intercept"</span><span class='op'>)</span>
<span class='op'>)</span>


<span class='va'>gaussian_slope_brm</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brm.html'>brm</a></span><span class='op'>(</span><span class='va'>gaussian_slope_bf</span>,
                          prior <span class='op'>=</span> <span class='va'>gaussian_slope_priors</span>,
                          data <span class='op'>=</span> <span class='va'>obs_data</span>, file <span class='op'>=</span> <span class='st'>"gaussian_slope_brm"</span>,
                          backend <span class='op'>=</span> <span class='st'>"cmdstanr"</span>, cores <span class='op'>=</span> <span class='fl'>4</span><span class='op'>)</span>

<span class='va'>gaussian_slope_brm</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/update.html'>update</a></span><span class='op'>(</span><span class='va'>gaussian_slope_brm</span>, newdata <span class='op'>=</span> <span class='va'>obs_data</span>, cores <span class='op'>=</span> <span class='fl'>4</span>, refresh <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Running MCMC with 4 parallel chains...

Chain 2 finished in 44.9 seconds.
Chain 1 finished in 45.5 seconds.
Chain 3 finished in 46.0 seconds.
Chain 4 finished in 46.4 seconds.

All 4 chains finished successfully.
Mean chain execution time: 45.7 seconds.
Total execution time: 46.7 seconds.</code></pre>
</div>
<p>calculate ICC(x)</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>gauss_slope_sample_draws</span> <span class='op'>&lt;-</span> <span class='fu'>expand_grid</span><span class='op'>(</span>sp_id <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span><span class='st'>"newsp"</span>, <span class='fl'>1</span><span class='op'>:</span><span class='fl'>100</span><span class='op'>)</span>,
                            water <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span>from <span class='op'>=</span> <span class='op'>-</span><span class='fl'>1</span>, to <span class='op'>=</span> <span class='fl'>1</span>, length.out <span class='op'>=</span> <span class='fl'>33</span><span class='op'>)</span><span class='op'>)</span> |&gt;
  <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html'>add_epred_draws</a></span><span class='op'>(</span><span class='va'>gaussian_slope_brm</span>,
                  allow_new_levels <span class='op'>=</span> <span class='cn'>TRUE</span>,
                  sample_new_levels<span class='op'>=</span> <span class='st'>"gaussian"</span><span class='op'>)</span>

<span class='va'>gauss_slope_sample_draws</span> |&gt; 
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>.draw</span> <span class='op'>==</span> <span class='fl'>121</span><span class='op'>)</span> |&gt; 
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>water</span>, y <span class='op'>=</span> <span class='va'>.epred</span>, group <span class='op'>=</span> <span class='va'>sp_id</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>geom_line</span><span class='op'>(</span>alpha <span class='op'>=</span> <span class='fl'>.3</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>theme_bw</span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="index_files/figure-html5/unnamed-chunk-6-1.png" width="624" /></p>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>gauss_slope_sample_variance</span> <span class='op'>&lt;-</span> <span class='va'>gauss_slope_sample_draws</span> |&gt;
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> |&gt;
  <span class='fu'>nest_by</span><span class='op'>(</span><span class='va'>.draw</span>, <span class='va'>water</span><span class='op'>)</span> |&gt;
  <span class='fu'>mutate</span><span class='op'>(</span>Vpred <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/cor.html'>var</a></span><span class='op'>(</span><span class='va'>data</span><span class='op'>$</span><span class='va'>.epred</span><span class='op'>)</span><span class='op'>)</span> |&gt; 
  <span class='fu'>select</span><span class='op'>(</span><span class='op'>-</span><span class='va'>data</span><span class='op'>)</span>

<span class='va'>sigma_draws</span> <span class='op'>&lt;-</span> <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>spread_draws</a></span><span class='op'>(</span><span class='va'>gaussian_slope_brm</span>, <span class='va'>sigma</span><span class='op'>)</span>

<span class='va'>gauss_slope_icc_of_x</span> <span class='op'>&lt;-</span> <span class='va'>gauss_slope_sample_variance</span> |&gt;
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> |&gt;
  <span class='fu'>left_join</span><span class='op'>(</span><span class='va'>sigma_draws</span>, by <span class='op'>=</span> <span class='st'>".draw"</span><span class='op'>)</span> |&gt;
  <span class='fu'>mutate</span><span class='op'>(</span>icc_x <span class='op'>=</span> <span class='va'>Vpred</span><span class='op'>/</span><span class='op'>(</span><span class='va'>Vpred</span> <span class='op'>+</span> <span class='va'>sigma</span><span class='op'>^</span><span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>gauss_slope_icc_of_x</span> |&gt; 
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>water</span>, y <span class='op'>=</span> <span class='va'>icc_x</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'><a href='http://mjskay.github.io/ggdist/reference/stat_lineribbon.html'>stat_lineribbon</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>scale_fill_brewer</span><span class='op'>(</span>palette <span class='op'>=</span> <span class='st'>"Greens"</span>, direction <span class='op'>=</span> <span class='op'>-</span><span class='fl'>1</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>labs</span><span class='op'>(</span>y <span class='op'>=</span> <span class='st'>"ICC(x)"</span>, x <span class='op'>=</span> <span class='st'>"Water"</span><span class='op'>)</span>
</code></pre>
</div>
<div class="figure"><span id="fig:icc-gauss-slopes"></span>
<img src="index_files/figure-html5/icc-gauss-slopes-1.png" alt="The ICC(x) for a random slopes model. In this case, the variation explained by groups is lowest in the middle of the gradient of X, and highest at the extremes." width="624" />
<p class="caption">
Figure 2: The ICC(x) for a random slopes model. In this case, the variation explained by groups is lowest in the middle of the gradient of X, and highest at the extremes.
</p>
</div>
</div>
<h2 id="nonlinear-models-normal-errors">Nonlinear models, normal errors</h2>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># rates vary slightly</span>
<span class='va'>log_mean_rate</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='fl'>0.7</span><span class='op'>)</span>

<span class='va'>log_indiv_ecart</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='fl'>15</span>, mean <span class='op'>=</span> <span class='fl'>0</span>, sd <span class='op'>=</span> <span class='fl'>.4</span><span class='op'>)</span>

<span class='va'>rates</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>log_mean_rate</span> <span class='op'>+</span> <span class='va'>log_indiv_ecart</span><span class='op'>)</span>

<span class='co'>## NORMAL OBS -----------------------------------</span>

<span class='co'>## observations are normally distributed</span>

<span class='va'>sd</span> <span class='op'>&lt;-</span> <span class='fl'>5</span>
<span class='va'>M0</span> <span class='op'>&lt;-</span> <span class='fl'>200</span>

<span class='va'>simulated_decay</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/expand.grid.html'>expand.grid</a></span><span class='op'>(</span>sample_id <span class='op'>=</span> <span class='fl'>1</span><span class='op'>:</span><span class='fl'>15</span>, time <span class='op'>=</span> <span class='fl'>0</span><span class='op'>:</span><span class='fl'>10</span><span class='op'>)</span> |&gt;
  <span class='fu'>mutate</span><span class='op'>(</span>rate <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>log_mean_rate</span> <span class='op'>+</span> <span class='va'>log_indiv_ecart</span><span class='op'>[</span><span class='va'>sample_id</span><span class='op'>]</span><span class='op'>)</span>,
         Mt  <span class='op'>=</span> <span class='va'>M0</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>rate</span><span class='op'>*</span><span class='va'>time</span><span class='op'>)</span>,
         obs_mass <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>Mt</span><span class='op'>)</span>,
                          mean <span class='op'>=</span> <span class='va'>Mt</span>,
                          sd <span class='op'>=</span> <span class='va'>sd</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>simulated_decay</span> |&gt;
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>time</span>, y <span class='op'>=</span> <span class='va'>Mt</span>, group <span class='op'>=</span> <span class='va'>sample_id</span><span class='op'>)</span><span class='op'>)</span><span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<img src="index_files/figure-html5/unnamed-chunk-8-1.png" width="624" />
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>data_figure</span> <span class='op'>&lt;-</span> <span class='va'>simulated_decay</span> |&gt;
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>time</span>, y <span class='op'>=</span> <span class='va'>Mt</span>, group <span class='op'>=</span> <span class='va'>sample_id</span><span class='op'>)</span><span class='op'>)</span><span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_point</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>obs_mass</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'>## brms mdeol</span>
<span class='va'>decay_normal_bf</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsformula.html'>bf</a></span><span class='op'>(</span><span class='va'>obs_mass</span> <span class='op'>~</span> <span class='fl'>200</span><span class='op'>*</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>rate</span><span class='op'>)</span> <span class='op'>*</span> <span class='va'>time</span><span class='op'>)</span>,
   <span class='va'>rate</span> <span class='op'>~</span> <span class='fl'>1</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>|</span> <span class='va'>sample_id</span><span class='op'>)</span>, nl <span class='op'>=</span> <span class='cn'>TRUE</span>, family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/family.html'>gaussian</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'>#get_prior(decay_normal_bf, data = simulated_decay)</span>

<span class='va'>decay_normal_priors</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>
  <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>prior</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsfamily.html'>exponential</a></span><span class='op'>(</span><span class='fl'>.3</span><span class='op'>)</span>, class <span class='op'>=</span> <span class='va'>sigma</span><span class='op'>)</span>,
  <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>prior</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsfamily.html'>exponential</a></span><span class='op'>(</span><span class='fl'>.2</span><span class='op'>)</span>, class <span class='op'>=</span> <span class='va'>sd</span>, nlpar <span class='op'>=</span> <span class='st'>"rate"</span><span class='op'>)</span>,
  <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>prior</a></span><span class='op'>(</span><span class='fu'>normal</span><span class='op'>(</span><span class='op'>-</span><span class='fl'>.5</span>, <span class='fl'>.5</span><span class='op'>)</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, nlpar <span class='op'>=</span> <span class='st'>"rate"</span><span class='op'>)</span>
<span class='op'>)</span>


<span class='va'>decay_brm</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brm.html'>brm</a></span><span class='op'>(</span><span class='va'>decay_normal_bf</span>,
                 prior <span class='op'>=</span> <span class='va'>decay_normal_priors</span>,
                 data <span class='op'>=</span> <span class='va'>simulated_decay</span>,
                 file <span class='op'>=</span> <span class='st'>"decay_normal"</span>,
                 backend <span class='op'>=</span> <span class='st'>"cmdstanr"</span>,
                 cores <span class='op'>=</span> <span class='fl'>4</span>, refresh <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span>

<span class='va'>decay_brm</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/update.html'>update</a></span><span class='op'>(</span><span class='va'>decay_brm</span>, newdata <span class='op'>=</span> <span class='va'>simulated_decay</span>, cores <span class='op'>=</span> <span class='fl'>4</span>, refresh <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Running MCMC with 4 parallel chains...

Chain 3 finished in 3.7 seconds.
Chain 4 finished in 3.6 seconds.
Chain 2 finished in 3.9 seconds.
Chain 1 finished in 4.0 seconds.

All 4 chains finished successfully.
Mean chain execution time: 3.8 seconds.
Total execution time: 4.2 seconds.</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'>#### make fake groups</span>
<span class='va'>new_groups</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span><span class='st'>"s"</span>, <span class='fl'>1</span><span class='op'>:</span><span class='fl'>33</span><span class='op'>)</span>

<span class='va'>sample_draws</span> <span class='op'>&lt;-</span> <span class='fu'>expand_grid</span><span class='op'>(</span>sample_id <span class='op'>=</span> <span class='va'>new_groups</span>,
                            time <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span>from <span class='op'>=</span> <span class='fl'>.1</span>,
                                       to <span class='op'>=</span> <span class='fl'>10</span>,
                                       length.out <span class='op'>=</span> <span class='fl'>40</span><span class='op'>)</span><span class='op'>)</span> |&gt;
  <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html'>add_epred_draws</a></span><span class='op'>(</span><span class='va'>decay_brm</span>,
                      allow_new_levels <span class='op'>=</span> <span class='cn'>TRUE</span>,
                      sample_new_levels<span class='op'>=</span> <span class='st'>"gaussian"</span><span class='op'>)</span>

<span class='va'>sample_draws</span> |&gt;
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> |&gt;
  <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>.draw</span><span class='op'>&lt;</span><span class='fl'>5</span><span class='op'>)</span> |&gt;
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>time</span>, y <span class='op'>=</span> <span class='va'>.epred</span>, group <span class='op'>=</span> <span class='va'>sample_id</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>facet_wrap</span><span class='op'>(</span><span class='op'>~</span><span class='va'>.draw</span><span class='op'>)</span>
</code></pre>
</div>
<img src="index_files/figure-html5/unnamed-chunk-8-2.png" width="624" />
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># for each draw, at each value of x,</span>
<span class='co'># calculate the variance of the predictions</span>

<span class='va'>sample_variance</span> <span class='op'>&lt;-</span> <span class='va'>sample_draws</span> |&gt; <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> |&gt;
  <span class='fu'>nest_by</span><span class='op'>(</span><span class='va'>.draw</span>, <span class='va'>time</span><span class='op'>)</span> |&gt;
  <span class='fu'>mutate</span><span class='op'>(</span>Vpred <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/cor.html'>var</a></span><span class='op'>(</span><span class='va'>data</span><span class='op'>$</span><span class='va'>.epred</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>sigma_draws</span> <span class='op'>&lt;-</span> <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>spread_draws</a></span><span class='op'>(</span><span class='va'>decay_brm</span>, <span class='va'>sigma</span><span class='op'>)</span>

<span class='va'>icc_of_x</span> <span class='op'>&lt;-</span> <span class='va'>sample_variance</span> |&gt;
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> |&gt;
  <span class='fu'>select</span><span class='op'>(</span><span class='va'>.draw</span>,<span class='va'>time</span>, <span class='va'>Vpred</span><span class='op'>)</span> |&gt;
  <span class='fu'>left_join</span><span class='op'>(</span><span class='va'>sigma_draws</span>, by <span class='op'>=</span> <span class='st'>".draw"</span><span class='op'>)</span> |&gt;
  <span class='fu'>mutate</span><span class='op'>(</span>icc_x <span class='op'>=</span> <span class='va'>Vpred</span><span class='op'>/</span><span class='op'>(</span><span class='va'>Vpred</span> <span class='op'>+</span> <span class='va'>sigma</span><span class='op'>^</span><span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>icc_figure</span> <span class='op'>&lt;-</span> <span class='va'>icc_of_x</span> |&gt;
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>time</span>, y <span class='op'>=</span> <span class='va'>icc_x</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='http://mjskay.github.io/ggdist/reference/stat_lineribbon.html'>stat_lineribbon</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>scale_fill_brewer</span><span class='op'>(</span>palette <span class='op'>=</span> <span class='st'>"Greens"</span>, direction <span class='op'>=</span> <span class='op'>-</span><span class='fl'>1</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>labs</span><span class='op'>(</span>y <span class='op'>=</span> <span class='st'>"ICC(x)"</span>, x <span class='op'>=</span> <span class='st'>"Time"</span><span class='op'>)</span>

<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://patchwork.data-imaginist.com'>patchwork</a></span><span class='op'>)</span>

<span class='va'>data_figure</span> <span class='op'>+</span> <span class='va'>icc_figure</span>
</code></pre>
</div>
<p><img src="index_files/figure-html5/unnamed-chunk-8-3.png" width="624" /></p>
</div>
<h2 id="decay-with-gamma-errors">Decay with Gamma errors</h2>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>alpha</span> <span class='op'>&lt;-</span> <span class='fl'>50</span>

<span class='va'>log_mean_rate</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='fl'>0.7</span><span class='op'>)</span>

<span class='va'>log_indiv_ecart</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='fl'>15</span>, mean <span class='op'>=</span> <span class='fl'>0</span>, sd <span class='op'>=</span> <span class='fl'>.7</span><span class='op'>)</span>

<span class='va'>simulated_decay_gamma</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/expand.grid.html'>expand.grid</a></span><span class='op'>(</span>sample_id <span class='op'>=</span> <span class='fl'>1</span><span class='op'>:</span><span class='fl'>15</span>, time <span class='op'>=</span> <span class='fl'>0</span><span class='op'>:</span><span class='fl'>10</span><span class='op'>)</span> |&gt;
  <span class='fu'>mutate</span><span class='op'>(</span>rate <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>log_mean_rate</span> <span class='op'>+</span> <span class='va'>log_indiv_ecart</span><span class='op'>[</span><span class='va'>sample_id</span><span class='op'>]</span><span class='op'>)</span>,
         Mt  <span class='op'>=</span> <span class='fl'>200</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>rate</span><span class='op'>*</span><span class='va'>time</span><span class='op'>)</span>,
         obs_mass <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/GammaDist.html'>rgamma</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>Mt</span><span class='op'>)</span>,shape <span class='op'>=</span> <span class='va'>alpha</span>, rate <span class='op'>=</span> <span class='va'>alpha</span><span class='op'>/</span><span class='va'>Mt</span><span class='op'>)</span><span class='op'>)</span> |&gt;
  <span class='fu'>mutate</span><span class='op'>(</span>sample_id <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span><span class='st'>"samp"</span>, <span class='va'>sample_id</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># replace 0s with smallest nonzero</span>
<span class='va'>tinymass</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/with.html'>with</a></span><span class='op'>(</span><span class='va'>simulated_decay_gamma</span>, <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>obs_mass</span><span class='op'>[</span><span class='va'>obs_mass</span><span class='op'>&gt;</span><span class='fl'>0</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>simulated_decay_gamma</span> <span class='op'>&lt;-</span> <span class='va'>simulated_decay_gamma</span> |&gt;
  <span class='fu'>mutate</span><span class='op'>(</span>obs_mass <span class='op'>=</span> <span class='fu'>if_else</span><span class='op'>(</span><span class='va'>obs_mass</span> <span class='op'>==</span> <span class='fl'>0</span>, <span class='va'>tinymass</span>, <span class='va'>obs_mass</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>gamma_data_figure</span> <span class='op'>&lt;-</span> <span class='va'>simulated_decay_gamma</span> |&gt;
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>time</span>, y <span class='op'>=</span> <span class='va'>Mt</span>, group <span class='op'>=</span> <span class='va'>sample_id</span> <span class='op'>)</span><span class='op'>)</span><span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_point</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>obs_mass</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>decay_gamma_bf</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsformula.html'>bf</a></span><span class='op'>(</span>
  <span class='va'>obs_mass</span> <span class='op'>~</span> <span class='fl'>200</span><span class='op'>*</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>rate</span><span class='op'>)</span> <span class='op'>*</span> <span class='va'>time</span><span class='op'>)</span>,
  <span class='va'>rate</span> <span class='op'>~</span> <span class='fl'>1</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>|</span> <span class='va'>sample_id</span><span class='op'>)</span>,
  nl <span class='op'>=</span> <span class='cn'>TRUE</span>,
  family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsfamily.html'>brmsfamily</a></span><span class='op'>(</span><span class='st'>"Gamma"</span>,
                      link <span class='op'>=</span> <span class='st'>"identity"</span>,
                      link_shape <span class='op'>=</span> <span class='st'>"log"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsformula-helpers.html'>lf</a></span><span class='op'>(</span><span class='va'>shape</span> <span class='op'>~</span> <span class='fl'>1</span><span class='op'>)</span>

<span class='co'>#get_prior(decay_gamma_bf, data = simulated_decay_gamma)</span>

<span class='va'>decay_gamma_priors</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>
  <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>prior</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsfamily.html'>exponential</a></span><span class='op'>(</span><span class='fl'>4</span><span class='op'>)</span>, class <span class='op'>=</span> <span class='st'>"sd"</span>, nlpar <span class='op'>=</span> <span class='st'>"rate"</span><span class='op'>)</span>,
  <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>prior</a></span><span class='op'>(</span><span class='fu'>normal</span><span class='op'>(</span><span class='op'>-</span><span class='fl'>.5</span>, <span class='fl'>.5</span><span class='op'>)</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, nlpar <span class='op'>=</span> <span class='st'>"rate"</span><span class='op'>)</span>,
  <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>prior</a></span><span class='op'>(</span><span class='fu'>normal</span><span class='op'>(</span><span class='fl'>4</span>, <span class='fl'>1</span><span class='op'>)</span>, class <span class='op'>=</span> <span class='st'>"Intercept"</span>, dpar  <span class='op'>=</span> <span class='st'>"shape"</span><span class='op'>)</span>
<span class='op'>)</span>


<span class='va'>decay_gamma_brm</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brm.html'>brm</a></span><span class='op'>(</span><span class='va'>decay_gamma_bf</span>,
                 prior <span class='op'>=</span> <span class='va'>decay_gamma_priors</span>,
                 data <span class='op'>=</span> <span class='va'>simulated_decay_gamma</span>,
                 file <span class='op'>=</span> <span class='st'>"decay_gamma_brm"</span>,
                 backend <span class='op'>=</span> <span class='st'>"cmdstanr"</span>, cores <span class='op'>=</span> <span class='fl'>4</span>,
                 sample_prior <span class='op'>=</span> <span class='st'>"yes"</span>, refresh <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span>

<span class='va'>decay_gamma_brm</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/update.html'>update</a></span><span class='op'>(</span><span class='va'>decay_gamma_brm</span>,
                          newdata <span class='op'>=</span> <span class='va'>simulated_decay_gamma</span>, 
                          cores <span class='op'>=</span> <span class='fl'>4</span>, refresh <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Running MCMC with 4 parallel chains...

Chain 2 finished in 47.6 seconds.
Chain 4 finished in 50.4 seconds.
Chain 1 finished in 50.1 seconds.
Chain 3 finished in 51.2 seconds.

All 4 chains finished successfully.
Mean chain execution time: 49.8 seconds.
Total execution time: 52.0 seconds.</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>decay_epred_draws</span> <span class='op'>&lt;-</span> <span class='fu'>expand_grid</span><span class='op'>(</span>time <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span>from <span class='op'>=</span> <span class='fl'>.1</span>,
                                            to <span class='op'>=</span> <span class='fl'>10</span>,
                                            length.out <span class='op'>=</span> <span class='fl'>40</span><span class='op'>)</span>,
                                 sample_id <span class='op'>=</span> <span class='va'>letters</span><span class='op'>)</span> |&gt;
  <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html'>add_epred_draws</a></span><span class='op'>(</span><span class='va'>decay_gamma_brm</span>,
                  allow_new_levels <span class='op'>=</span> <span class='cn'>TRUE</span>,
                  sample_new_levels<span class='op'>=</span> <span class='st'>"gaussian"</span><span class='op'>)</span>


<span class='co'># calculate the variance among groups for each value of x (here x is time)</span>
<span class='va'>decay_var_epred</span> <span class='op'>&lt;-</span> <span class='va'>decay_epred_draws</span> |&gt;
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> |&gt;
  <span class='fu'>nest_by</span><span class='op'>(</span><span class='va'>.draw</span>, <span class='va'>time</span><span class='op'>)</span> |&gt;
  <span class='fu'>mutate</span><span class='op'>(</span>Vpred <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/cor.html'>var</a></span><span class='op'>(</span><span class='va'>data</span><span class='op'>$</span><span class='va'>.epred</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># get the shape.. first what was it called</span>
<span class='co'># decay_gamma_brm |&gt; get_variables()</span>

<span class='va'>shape_draws</span> <span class='op'>&lt;-</span> <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>spread_draws</a></span><span class='op'>(</span><span class='va'>decay_gamma_brm</span>, <span class='va'>Intercept_shape</span><span class='op'>)</span>

<span class='co'># stancode(decay_gamma_brm)</span>
<span class='co'># need to exponentiate the shape draws as well!</span>

<span class='va'>decay_gamma_mu_shape</span> <span class='op'>&lt;-</span> <span class='va'>decay_var_epred</span> |&gt;
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> |&gt;
  <span class='fu'>left_join</span><span class='op'>(</span><span class='va'>shape_draws</span>, by <span class='op'>=</span> <span class='st'>".draw"</span><span class='op'>)</span>

<span class='co'># calculate variance and then calculate icc</span>
<span class='va'>icc_gamma</span> <span class='op'>&lt;-</span> <span class='va'>decay_gamma_mu_shape</span> |&gt;
  <span class='fu'>rowwise</span><span class='op'>(</span><span class='op'>)</span> |&gt;
  <span class='co'># exponentiante shape and divide the square of the mean by that</span>
  <span class='fu'>mutate</span><span class='op'>(</span>shape <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>Intercept_shape</span><span class='op'>)</span>,
         mu_sq <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>data</span><span class='op'>$</span><span class='va'>.epred</span><span class='op'>^</span><span class='fl'>2</span><span class='op'>)</span>,
         var_k <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>mu_sq</span> <span class='op'>/</span> <span class='va'>shape</span><span class='op'>)</span>,
         mean_var <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>var_k</span><span class='op'>)</span><span class='op'>)</span>


<span class='va'>clean_icc</span> <span class='op'>&lt;-</span> <span class='va'>icc_gamma</span> |&gt;
  <span class='fu'>mutate</span><span class='op'>(</span>icc_x <span class='op'>=</span> <span class='va'>Vpred</span><span class='op'>/</span><span class='op'>(</span><span class='va'>Vpred</span> <span class='op'>+</span> <span class='va'>mean_var</span><span class='op'>)</span><span class='op'>)</span> |&gt;
  <span class='fu'>select</span><span class='op'>(</span><span class='va'>time</span>, <span class='va'>.draw</span>, <span class='va'>icc_x</span><span class='op'>)</span> |&gt;
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>gamma_icc_fig</span> <span class='op'>&lt;-</span> <span class='va'>clean_icc</span> |&gt;
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>time</span>, y <span class='op'>=</span> <span class='va'>icc_x</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='http://mjskay.github.io/ggdist/reference/stat_lineribbon.html'>stat_lineribbon</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>scale_fill_brewer</span><span class='op'>(</span>palette <span class='op'>=</span> <span class='st'>"Greens"</span>, direction <span class='op'>=</span> <span class='op'>-</span><span class='fl'>1</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>labs</span><span class='op'>(</span>y <span class='op'>=</span> <span class='st'>"ICC(x)"</span>, x <span class='op'>=</span> <span class='st'>"Time"</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>gamma_data_figure</span> <span class='op'>+</span> <span class='va'>gamma_icc_fig</span>
</code></pre>
</div>
<div class="figure"><span id="fig:fig-gamma-decay-icc"></span>
<img src="index_files/figure-html5/fig-gamma-decay-icc-1.png" alt="ICC for an exponential decay model with gamma errors. Because the variance is proportionally smaller than the mean, as the mean goes to 0 it takes the variance with it (but even faster). The result is that soon group ID controls almost all of the variation. This variation however is practically 0, since and this point almost everything has decayed to 0" width="624" />
<p class="caption">
Figure 3: ICC for an exponential decay model with gamma errors. Because the variance is proportionally smaller than the mean, as the mean goes to 0 it takes the variance with it (but even faster). The result is that soon group ID controls almost all of the variation. This variation however is practically 0, since and this point almost everything has decayed to 0
</p>
</div>
</div>
<p>Two models, each with very comparable structures, give completely opposite ICC(x) curves. Its an interesting consequence of extending the ICC in this way.</p>
<h1 id="discussion">Discussion</h1>
<p>Whats this good for? This extension of the classic ICC approach can apply to a much wider range of models, but it is also more complex to interpret. For example, theres no clear way to put a single number on the outcome. For all but the simplest models, it is no longer possible to make a statment like repeatability of this behaviour among animals was 60%. Instead, wed have to say something like repeatability reached a maximum value of 60% (HDPI between 51 and 67%) after 5 days, after which it declined, or the ICC reached a value greater than 90% when water addition increased beyond 60L per m<sup>2</sup></p>
<p>Because every quantity from a bayesian model has a posterior distribution, this approach would let us calculate both repeatability and broad-sense heritability (two interpretations of the ICC) for model-derived quantities. For example, we could expose many clonal lines of, say, aphids to different temperatures and measure population growth rates for each line at each temperature. This data could be modelled with thermal performance curves, each of which has several parameters. These parameters would be drawn from a multivariate normal distribution that would describe the variation among genotypes (clonal lines). With the resulting model it would be possible to measure the broad-sense heritability of, say, the temperature at which population growth rates are maximized.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-GelmGood19a" class="csl-entry" role="doc-biblioentry">
Gelman, Andrew, Ben Goodrich, Jonah Gabry, and Aki Vehtari. 2019. <span>R-Squared for <span>Bayesian Regression Models</span>.</span> <em>The American Statistician</em> 73 (3): 3079. <a href="https://doi.org/10.1080/00031305.2018.1549100">https://doi.org/10.1080/00031305.2018.1549100</a>.
</div>
<div id="ref-NakaSchi10" class="csl-entry" role="doc-biblioentry">
Nakagawa, Shinichi, and Holger Schielzeth. 2010. <span>Repeatability for <span>Gaussian</span> and Non-<span>Gaussian</span> Data: A Practical Guide for Biologists.</span> <em>Biological Reviews</em> 85 (4): 93556. <a href="https://doi.org/10.1111/j.1469-185X.2010.00141.x">https://doi.org/10.1111/j.1469-185X.2010.00141.x</a>.
</div>
<div id="ref-stoffel2017" class="csl-entry" role="doc-biblioentry">
Stoffel, Martin A., Shinichi Nakagawa, and Holger Schielzeth. 2017. <span>rptR: Repeatability Estimation and Variance Decomposition by Generalized Linear Mixed-Effects Models.</span> <em>Methods in Ecology and Evolution</em> 8: 1639???1644. <a href="https://doi.org/10.1111/2041-210X.12797">https://doi.org/10.1111/2041-210X.12797</a>.
</div>
</div>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>I think it should be possible to extend this to multiple X values, in which case the ICC would become not a curve but a surface!<a href="#fnref1" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn2" role="doc-endnote"><p>I will probably have to ask this question of the creator of the wonderful <code>tidybayes</code>, Matthew Kay<a href="#fnref2" class="footnote-back" role="doc-backlink"></a></p></li>
</ol>
</section>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom">
<h3 id="references">References</h3>
<div id="references-listing"></div>
</div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
